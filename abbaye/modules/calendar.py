""" Module calendar. """

import datetime
from math import floor

DAYS = {
    '0101': 110,
    '0102': 40,
    '0103': 40,
    '0106': 110,
    '0113': 40,
    '0114': 20,
    '0115': 40,
    '0117': 40,
    '0120': 20,
    '0121': 40,
    '0122': 20,
    '0124': 40,
    '0125': 70,
    '0126': 20,
    '0127': 20,
    '0128': 40,
    '0130': 20,
    '0131': 40,
    '0202_dim': 90,
    '0202_fer': 90,
    '0203': 20,
    '0205': 40,
    '0206': 20,
    '0208': 20,
    '0210': 70,
    '0211': 40,
    '0212': 40,
    '0214': 70,
    '0217': 20,
    '0218': 20,
    '0221': 40,
    '0222': 70,
    '0223': 40,
    '0307': 40,
    '0308': 20,
    '0309': 40,
    '0319': 110,
    '0321': 70,
    '0325': 110,
    '0407': 40,
    '0411': 20,
    '0413': 20,
    '0421': 40,
    '0425': 70,
    '0427': 60,
    '0428': 20,
    '0429': 70,
    '0430': 20,
    '0501': 40,
    '0502': 40,
    '0503': 70,
    '0511': 40,
    '0513': 20,
    '0514': 70,
    '0515': 40,
    '0518': 20,
    '0519': 20,
    '0525': 40,
    '0526': 20,
    '0527': 20,
    '0530': 40,
    '0531': 70,
    '0601': 40,
    '0602': 20,
    '0603': 40,
    '0605': 40,
    '0609': 20,
    '0611': 40,
    '0613': 40,
    '0619': 40,
    '0621': 20,
    '0622': 20,
    '0624': 110,
    '0627': 20,
    '0628': 40,
    '0629': 110,
    '0630': 20,
    '0703': 70,
    '0706': 20,
    '0711': 110,
    '0712': 20,
    '0714': 20,
    '0715': 40,
    '0716_fer': 20,
    '0716_sam': 40,
    '0721': 20,
    '0722': 40,
    '0723': 70,
    '0725': 70,
    '0726': 40,
    '0729': 40,
    '0730': 20,
    '0731': 40,
    '0801': 40,
    '0802': 20,
    '0804': 40,
    '0805': 20,
    '0806_dim': 70,
    '0806_fer': 70,
    '0808': 40,
    '0809': 70,
    '0810': 70,
    '0811': 20,
    '0812': 20,
    '0814': 40,
    '0815': 110,
    '0819': 40,
    '0820': 70,
    '0821': 40,
    '0822': 40,
    '0824': 70,
    '0825': 20,
    '0827': 40,
    '0828': 40,
    '0829': 40,
    '0903': 70,
    '0907': 110,
    '0908': 70,
    '0912': 40,
    '0913': 40,
    '0914_dim': 90,
    '0914_fer': 70,
    '0915': 40,
    '0916': 40,
    '0917_1': 20,
    '0917_2': 20,
    '0919': 20,
    '0920': 20,
    '0921': 70,
    '0923': 20,
    '0926': 20,
    '0927': 40,
    '0929': 70,
    '0930': 40,
    '1001': 40,
    '1002': 40,
    '1004': 40,
    '1005': 20,
    '1006': 40,
    '1007': 40,
    '1009': 20,
    '1015': 40,
    '1016': 20,
    '1017': 40,
    '1018': 70,
    '1019': 20,
    '1022': 20,
    '1023': 40,
    '1024': 20,
    '1028': 70,
    '1101': 110,
    '1102': 110,
    '1103': 20,
    '1104': 40,
    '1108': 20,
    '1109_dim': 90,
    '1109_fer': 90,
    '1110': 40,
    '1111': 70,
    '1112': 20,
    '1113': 70,
    '1115': 20,
    '1116': 40,
    '1117': 20,
    '1118': 20,
    '1121': 40,
    '1122': 40,
    '1123': 40,
    '1124': 20,
    '1125': 20,
    '1130': 70,
    '1203': 40,
    '1207': 40,
    '1208': 110,
    '1210': 20,
    '1212': 20,
    '1213': 40,
    '1214': 40,
    '1217': 50,
    '1218': 50,
    '1219': 50,
    '1220': 50,
    '1221': 50,
    '1222': 50,
    '1223': 50,
    '1224': 50,
    '1225': 120,
    '1226': 70,
    '1227': 70,
    '1228': 70,
    '1229': 50,
    '1230': 50,
    '1231': 50,
    'adv_1_0': 120,
    'adv_1_1': 10,
    'adv_1_2': 10,
    'adv_1_3': 10,
    'adv_1_4': 10,
    'adv_1_5': 10,
    'adv_1_6': 10,
    'adv_2_0': 120,
    'adv_2_1': 10,
    'adv_2_2': 10,
    'adv_2_3': 10,
    'adv_2_4': 10,
    'adv_2_5': 10,
    'adv_2_6': 10,
    'adv_3_0': 120,
    'adv_3_1': 10,
    'adv_3_2': 10,
    'adv_3_3': 10,
    'adv_3_4': 10,
    'adv_3_5': 10,
    'adv_4_0': 120,
    'bapt': 80,
    'cendres_0': 120,
    'cendres_1': 50,
    'cendres_2': 50,
    'cendres_3': 50,
    'christ_roi': 110,
    'fete_dieu': 110,
    'marie_mere_eglise': 30,
    'noel_dim_2': 80,
    'noel_time_1': 10,
    'noel_time_2': 10,
    'noel_time_3': 10,
    'pa_1_1': 10,
    'pa_1_2': 10,
    'pa_1_3': 10,
    'pa_1_4': 10,
    'pa_1_5': 10,
    'pa_1_6': 10,
    'pa_10_0': 80,
    'pa_10_1': 10,
    'pa_10_2': 10,
    'pa_10_3': 10,
    'pa_10_4': 10,
    'pa_10_5': 10,
    'pa_10_6': 10,
    'pa_11_0': 80,
    'pa_11_1': 10,
    'pa_11_2': 10,
    'pa_11_3': 10,
    'pa_11_4': 10,
    'pa_11_5': 10,
    'pa_11_6': 10,
    'pa_12_0': 80,
    'pa_12_1': 10,
    'pa_12_2': 10,
    'pa_12_3': 10,
    'pa_12_4': 10,
    'pa_12_5': 10,
    'pa_12_6': 10,
    'pa_13_0': 80,
    'pa_13_1': 10,
    'pa_13_2': 10,
    'pa_13_3': 10,
    'pa_13_4': 10,
    'pa_13_5': 10,
    'pa_13_6': 10,
    'pa_14_0': 80,
    'pa_14_1': 10,
    'pa_14_2': 10,
    'pa_14_3': 10,
    'pa_14_4': 10,
    'pa_14_5': 10,
    'pa_14_6': 10,
    'pa_15_0': 80,
    'pa_15_1': 10,
    'pa_15_2': 10,
    'pa_15_3': 10,
    'pa_15_4': 10,
    'pa_15_5': 10,
    'pa_15_6': 10,
    'pa_16_0': 80,
    'pa_16_1': 10,
    'pa_16_2': 10,
    'pa_16_3': 10,
    'pa_16_4': 10,
    'pa_16_5': 10,
    'pa_16_6': 10,
    'pa_17_0': 80,
    'pa_17_1': 10,
    'pa_17_2': 10,
    'pa_17_3': 10,
    'pa_17_4': 10,
    'pa_17_5': 10,
    'pa_17_6': 10,
    'pa_18_0': 80,
    'pa_18_1': 10,
    'pa_18_2': 10,
    'pa_18_3': 10,
    'pa_18_4': 10,
    'pa_18_5': 10,
    'pa_18_6': 10,
    'pa_19_0': 80,
    'pa_19_1': 10,
    'pa_19_2': 10,
    'pa_19_3': 10,
    'pa_19_4': 10,
    'pa_19_5': 10,
    'pa_19_6': 10,
    'pa_2_0': 80,
    'pa_2_1': 10,
    'pa_2_2': 10,
    'pa_2_3': 10,
    'pa_2_4': 10,
    'pa_2_5': 10,
    'pa_2_6': 10,
    'pa_20_0': 80,
    'pa_20_1': 10,
    'pa_20_2': 10,
    'pa_20_3': 10,
    'pa_20_4': 10,
    'pa_20_5': 10,
    'pa_20_6': 10,
    'pa_21_0': 80,
    'pa_21_1': 10,
    'pa_21_2': 10,
    'pa_21_3': 10,
    'pa_21_4': 10,
    'pa_21_5': 10,
    'pa_21_6': 10,
    'pa_22_0': 80,
    'pa_22_1': 10,
    'pa_22_2': 10,
    'pa_22_3': 10,
    'pa_22_4': 10,
    'pa_22_5': 10,
    'pa_22_6': 10,
    'pa_23_0': 80,
    'pa_23_1': 10,
    'pa_23_2': 10,
    'pa_23_3': 10,
    'pa_23_4': 10,
    'pa_23_5': 10,
    'pa_23_6': 10,
    'pa_24_0': 80,
    'pa_24_1': 10,
    'pa_24_2': 10,
    'pa_24_3': 10,
    'pa_24_4': 10,
    'pa_24_5': 10,
    'pa_24_6': 10,
    'pa_25_0': 80,
    'pa_25_1': 10,
    'pa_25_2': 10,
    'pa_25_3': 10,
    'pa_25_4': 10,
    'pa_25_5': 10,
    'pa_25_6': 10,
    'pa_26_0': 80,
    'pa_26_1': 10,
    'pa_26_2': 10,
    'pa_26_3': 10,
    'pa_26_4': 10,
    'pa_26_5': 10,
    'pa_26_6': 10,
    'pa_27_0': 80,
    'pa_27_1': 10,
    'pa_27_2': 10,
    'pa_27_3': 10,
    'pa_27_4': 10,
    'pa_27_5': 10,
    'pa_27_6': 10,
    'pa_28_0': 80,
    'pa_28_1': 10,
    'pa_28_2': 10,
    'pa_28_3': 10,
    'pa_28_4': 10,
    'pa_28_5': 10,
    'pa_28_6': 10,
    'pa_29_0': 80,
    'pa_29_1': 10,
    'pa_29_2': 10,
    'pa_29_3': 10,
    'pa_29_4': 10,
    'pa_29_5': 10,
    'pa_29_6': 10,
    'pa_3_0': 80,
    'pa_3_1': 10,
    'pa_3_2': 10,
    'pa_3_3': 10,
    'pa_3_4': 10,
    'pa_3_5': 10,
    'pa_3_6': 10,
    'pa_30_0': 80,
    'pa_30_1': 10,
    'pa_30_2': 10,
    'pa_30_3': 10,
    'pa_30_4': 10,
    'pa_30_5': 10,
    'pa_30_6': 10,
    'pa_31_0': 80,
    'pa_31_1': 10,
    'pa_31_2': 10,
    'pa_31_3': 10,
    'pa_31_4': 10,
    'pa_31_5': 10,
    'pa_31_6': 10,
    'pa_32_0': 80,
    'pa_32_1': 10,
    'pa_32_2': 10,
    'pa_32_3': 10,
    'pa_32_4': 10,
    'pa_32_5': 10,
    'pa_32_6': 10,
    'pa_33_0': 80,
    'pa_33_1': 10,
    'pa_33_2': 10,
    'pa_33_3': 10,
    'pa_33_4': 10,
    'pa_33_5': 10,
    'pa_33_6': 10,
    'pa_34_1': 10,
    'pa_34_2': 10,
    'pa_34_3': 10,
    'pa_34_4': 10,
    'pa_34_5': 10,
    'pa_34_6': 10,
    'pa_4_0': 80,
    'pa_4_1': 10,
    'pa_4_2': 10,
    'pa_4_3': 10,
    'pa_4_4': 10,
    'pa_4_5': 10,
    'pa_4_6': 10,
    'pa_5_0': 80,
    'pa_5_1': 10,
    'pa_5_2': 10,
    'pa_5_3': 10,
    'pa_5_4': 10,
    'pa_5_5': 10,
    'pa_5_6': 10,
    'pa_6_0': 80,
    'pa_6_1': 10,
    'pa_6_2': 10,
    'pa_6_3': 10,
    'pa_6_4': 10,
    'pa_6_5': 10,
    'pa_6_6': 10,
    'pa_7_0': 80,
    'pa_7_1': 10,
    'pa_7_2': 10,
    'pa_7_3': 10,
    'pa_7_4': 10,
    'pa_7_5': 10,
    'pa_7_6': 10,
    'pa_8_0': 80,
    'pa_8_1': 10,
    'pa_8_2': 10,
    'pa_8_3': 10,
    'pa_8_4': 10,
    'pa_8_5': 10,
    'pa_8_6': 10,
    'pa_9_0': 80,
    'pa_9_1': 10,
    'pa_9_2': 10,
    'pa_9_3': 10,
    'pa_9_4': 10,
    'pa_9_5': 10,
    'pa_9_6': 10,
    'pentec': 120,
    'pro_unitate': 10,
    'qua_1_0': 120,
    'qua_1_1': 50,
    'qua_1_2': 50,
    'qua_1_3': 50,
    'qua_1_4': 50,
    'qua_1_5': 50,
    'qua_1_6': 50,
    'qua_2_0': 120,
    'qua_2_1': 50,
    'qua_2_2': 50,
    'qua_2_3': 50,
    'qua_2_4': 50,
    'qua_2_5': 50,
    'qua_2_6': 50,
    'qua_3_0': 120,
    'qua_3_1': 50,
    'qua_3_2': 50,
    'qua_3_3': 50,
    'qua_3_4': 50,
    'qua_3_5': 50,
    'qua_3_6': 50,
    'qua_4_0': 120,
    'qua_4_1': 50,
    'qua_4_2': 50,
    'qua_4_3': 50,
    'qua_4_4': 50,
    'qua_4_5': 50,
    'qua_4_6': 50,
    'qua_5_0': 120,
    'qua_5_1': 50,
    'qua_5_2': 50,
    'qua_5_3': 50,
    'qua_5_4': 50,
    'qua_5_5': 50,
    'qua_5_6': 50,
    'qua_6_0': 120,
    'sacre_coeur': 110,
    'ste_famille_dim': 90,
    'ste_famille_fer': 90,
    'tp_1_0': 120,
    'tp_1_1': 120,
    'tp_1_2': 120,
    'tp_1_3': 120,
    'tp_1_4': 120,
    'tp_1_5': 120,
    'tp_1_6': 120,
    'tp_2_0': 120,
    'tp_2_1': 10,
    'tp_2_2': 10,
    'tp_2_3': 10,
    'tp_2_4': 10,
    'tp_2_5': 10,
    'tp_2_6': 10,
    'tp_3_0': 120,
    'tp_3_1': 10,
    'tp_3_2': 10,
    'tp_3_3': 10,
    'tp_3_4': 10,
    'tp_3_5': 10,
    'tp_3_6': 10,
    'tp_4_0': 120,
    'tp_4_1': 10,
    'tp_4_2': 10,
    'tp_4_3': 10,
    'tp_4_4': 10,
    'tp_4_5': 10,
    'tp_4_6': 10,
    'tp_5_0': 120,
    'tp_5_1': 10,
    'tp_5_2': 10,
    'tp_5_3': 10,
    'tp_5_4': 10,
    'tp_5_5': 10,
    'tp_5_6': 10,
    'tp_6_0': 120,
    'tp_6_1': 10,
    'tp_6_2': 10,
    'tp_6_3': 10,
    'tp_6_4': 120,
    'tp_6_5': 10,
    'tp_6_6': 10,
    'tp_7_0': 120,
    'tp_7_1': 10,
    'tp_7_2': 10,
    'tp_7_3': 10,
    'tp_7_4': 10,
    'tp_7_5': 10,
    'tp_7_6': 10,
    'trinite': 70,
}


def get_first_sunday_of_advent(year):
    """ Return the date of 1st Sunday of Advent for the given civil year. """
    christmas_date = datetime.date(year, 12, 25)
    christmas_weekday = christmas_date.weekday()
    return christmas_date - datetime.timedelta(days=(christmas_weekday + 22))


def get_easter(year):
    """ Returns the Easter date for the given liturgical year. """
    v1 = year - 1900
    v2 = v1 % 19
    v3 = (((v2 * 7) + 1) // 19)
    v4 = ((v2 * 11) + 4 - v3) % 29
    v5 = (v1 // 4)
    v6 = (v1 + v5 + 31 - v4) % 7
    v7 = 25 - v4 - v6
    easter_day = v7 if v7 > 0 else (31 + v7)
    easter_month = 4 if v7 > 0 else 3
    return datetime.date(year, easter_month, easter_day)


def get_tempo(date):
    """ Returns the tempo ref according to the given date. """

    weekday = (date.weekday() + 1) if date.weekday() != 6 else 0
    first_sunday_of_advent = get_first_sunday_of_advent(date.year)
    liturgical_year = date.year if date < first_sunday_of_advent\
        else (date.year + 1)
    first_sunday_of_advent = get_first_sunday_of_advent(liturgical_year - 1)
    christmas = datetime.date(liturgical_year - 1, 12, 25)
    if christmas.weekday() == 6:
        holy_family = datetime.date(liturgical_year - 1, 12, 30)
        baptism_of_christ = datetime.date(liturgical_year, 1, 7)
    else:
        holy_family = christmas + \
            datetime.timedelta(days=(6 - christmas.weekday()))
        baptism_of_christ = holy_family + datetime.timedelta(days=14) if christmas.weekday() != 0 \
            else datetime.date(liturgical_year, 1, 7)
    easter = get_easter(liturgical_year)
    ash = easter - datetime.timedelta(days=46)
    pentecost = easter + datetime.timedelta(days=49)
    first_sunday_of_next_advent = get_first_sunday_of_advent(liturgical_year)
    christ_king = first_sunday_of_next_advent - datetime.timedelta(days=7)
    if first_sunday_of_advent <= date < christmas:
        tempo = 'adv'
    elif christmas <= date < baptism_of_christ:
        tempo = 'noel'
    elif baptism_of_christ <= date < ash:
        tempo = 'pa_before_ash'
    elif ash <= date < easter:
        tempo = 'lent'
    elif easter <= date <= pentecost:
        tempo = 'tp'
    elif pentecost <= date < first_sunday_of_next_advent:
        if date == pentecost + datetime.timedelta(days=7):
            tempo = 'trinite'
        elif date == pentecost + datetime.timedelta(days=11):
            tempo = 'fete_dieu'
        elif date == pentecost + datetime.timedelta(days=19):
            tempo = 'sacre_coeur'
        elif date == christ_king:
            tempo = 'christ_roi'
        else:
            days = (first_sunday_of_next_advent - date).days
            week = 35 - floor(
                (days / 7) + (1 if weekday != 0 else 0)
            )
            tempo = 'pa_{}_{}'.format(week, weekday)
    return tempo


def get_sancto(date):
    """ Returns the sancto ref according to the given date. """
    month = date.strftime('%m')
    day = date.strftime('%d')
    sancto = '{}{}'.format(month, day)
    weekday = (date.weekday() + 1) if date.weekday() != 6 else 0
    if sancto in ['0202', '0806', '0914', '1109']:
        if weekday == 0:
            sancto += '_dim'
        else:
            sancto += '_fer'
    return sancto


def get_liturgical_day(date):
    """ Returns the winner after comparison of forces. """
    tempo = get_tempo(date)
    sancto = get_sancto(date)
    if sancto in DAYS.keys():
        if DAYS[tempo] > DAYS[sancto]:
            liturgical_day = tempo
        else:
            liturgical_day = sancto
    else:
        sancto = None
        liturgical_day = tempo
    return(tempo, sancto, liturgical_day)
